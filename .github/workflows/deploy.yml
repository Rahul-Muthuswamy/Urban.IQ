name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

env:
  APP_FRONTEND: ${{ secrets.APP_FRONTEND }}
  APP_BACKEND: ${{ secrets.APP_BACKEND }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP || 'urbaniq-rg' }}
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  deploy-backend:
    name: Deploy Backend to Azure App Service
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create deployment package
      working-directory: ./backend
      run: |
        # Create a zip file excluding unnecessary files
        zip -r ../backend-deploy.zip . \
          -x "*.pyc" \
          -x "__pycache__/*" \
          -x "*.log" \
          -x ".env*" \
          -x "venv/*" \
          -x ".git/*" \
          -x "migrations/*" \
          -x "*.md" \
          -x "*.bat" \
          -x "*.sh"

    - name: Configure Azure App Service startup command
      run: |
        az webapp config set \
          --name ${{ env.APP_BACKEND }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --startup-file "gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 120 --access-logfile - --error-logfile - threaddit:app"

    - name: Deploy backend to Azure App Service
      uses: azure/webapps-deploy@v4
      with:
        app-name: ${{ env.APP_BACKEND }}
        package: ./backend-deploy.zip
        resource-group: ${{ env.RESOURCE_GROUP }}

  deploy-frontend:
    name: Deploy Frontend to Azure App Service
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend_new/package-lock.json

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install dependencies
      working-directory: ./frontend_new
      run: npm ci

    - name: Build frontend
      working-directory: ./frontend_new
      run: npm run build
      env:
        NODE_ENV: production

    - name: Deploy frontend to Azure App Service
      uses: azure/webapps-deploy@v4
      with:
        app-name: ${{ env.APP_FRONTEND }}
        package: ./frontend_new/dist
        resource-group: ${{ env.RESOURCE_GROUP }}

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "=========================================="
        echo "Deployment Complete!"
        echo "=========================================="
        echo "Backend: https://${{ env.APP_BACKEND }}.azurewebsites.net"
        echo "Frontend: https://${{ env.APP_FRONTEND }}.azurewebsites.net"
        echo "Commit: ${{ github.sha }}"
        echo "=========================================="
